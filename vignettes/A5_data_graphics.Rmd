---
title: "A5 Data graphics"
shorttitle: "Data graphics"
author: "Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{A5 Data graphics}
  %\VignetteEncoding{UTF-8}
output:
  rmarkdown::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---

```{r setup,echo=FALSE,results="hide"}
suppressMessages({
 suppressPackageStartupMessages({
  library(YESCDS)
library(tibble)
library(dplyr)
library(plotly)
library(ggplot2)
library(ggbeeswarm)
library(DT)
data(woncan_meta)
data(woncan)
littab = woncan |> select(MSA, `Cancer Sites`, Age.Adjusted.Rate) |> as.data.frame()
  })
 })
```

# Visualizing variability

We have been looking at cancer incidence data in the form of tables of numbers.
We can sort, search, filter these tables fairly easily.  "Data graphics", also
known as "statistical visualization", have been devised to help us get
insights that have a different character.  One objective is to develop a
sense of variation in a quantity of interest, by aggregating data values in
various ways and presenting these aggregates in graphical form.

```{r doit, echo=FALSE}
make_hist = function(site="Prostate", binwidth=5, rate_table) {
 stopifnot( all(c("Cancer Sites", "Age.Adjusted.Rate", "MSA") %in% names(rate_table)) )
 tt = rate_table |> filter(`Cancer Sites` == site)
 suppressMessages({
  suppressWarnings({
   gg = ggplot(tt, aes(x=Age.Adjusted.Rate, text=MSA)) + geom_histogram(binwidth=binwidth) + ggtitle(paste("CDC WONDER incidence for ", site, sep=""))
   ggplotly(gg)
  })
 })
}

make_boxplot1 = function(site="Prostate", MSA.in="Baton Rouge, LA", rate_table) {
 stopifnot( all(c("Cancer Sites", "Age.Adjusted.Rate", "MSA") %in% names(rate_table)) )
 tt = rate_table |> filter(MSA == MSA.in) 
 suppressMessages({
  suppressWarnings({
   gg = ggplot(tt, aes(y=Age.Adjusted.Rate, text=`Cancer Sites`)) + geom_boxplot() + ggtitle(paste("CDC WONDER incidence for ", site, sep="")) + scale_y_log10()
  })
 })
 gg
}

make_pair = function(MSA1="Baton Rouge, LA", MSA2="Tucson, AZ", type="boxplot", rate_table) {
 stopifnot( all(c("Cancer Sites", "Age.Adjusted.Rate", "MSA") %in% names(rate_table)) )
 tt = rate_table |> filter(MSA %in% c(MSA1, MSA2)) |> filter(`Cancer Sites` != "All Invasive Cancer Sites Combined")
 tt = tt |> filter(Age.Adjusted.Rate > 0)
 suppressMessages({
  suppressWarnings({
  if (type == "boxplot")
   gg = ggplot(tt, aes(y=Age.Adjusted.Rate, text=`Cancer Sites`, group=MSA)) + geom_boxplot(aes(x=MSA, group=MSA)) + ggtitle(paste("CDC WONDER incidence distribution for ", paste(MSA1, MSA2, sep=", "), sep="")) + scale_y_log10() 
   else gg = ggplot(tt, aes(y=Age.Adjusted.Rate, text=`Cancer Sites`)) + geom_quasirandom(aes(x=MSA)) + ggtitle(paste("CDC WONDER incidence distribution for ", paste(MSA1, MSA2, sep=", "), sep="")) + scale_y_log10() 
   gg
  })
 })
}

make_comparison = function(MSA1="Baton Rouge, LA", MSA2="Tucson, AZ", logscale=TRUE, type="scatter", rate_table) {
 stopifnot( all(c("Cancer Sites", "Age.Adjusted.Rate", "MSA") %in% names(rate_table)) )
 tt = rate_table |> filter(MSA %in% c(MSA1, MSA2)) |> filter(`Cancer Sites` != "All Invasive Cancer Sites Combined")
 tt = tt |> filter(Age.Adjusted.Rate > 0)
 tt1 = tt |> filter(MSA==MSA1)
 tt2 = tt |> filter(MSA==MSA2)
 si1 = tt1$`Cancer Sites`
 si2 = tt2$`Cancer Sites`
 oksi = intersect(si1,si2)
 tt1 = tt1 |> filter(`Cancer Sites` %in% oksi)
 tt2 = tt2 |> filter(`Cancer Sites` %in% oksi)
 rate.x = tt1$Age.Adjusted.Rate
 names(rate.x) = tt1$`Cancer Sites`
 rate.y = tt2$Age.Adjusted.Rate
 names(rate.y) = tt2$`Cancer Sites`
 rate.y = rate.y[names(rate.x)] # coordinate the two vectors
 newdf = data.frame(MSA1=MSA1, MSA2=MSA2, rate.x=rate.x, rate.y=rate.y, `Cancer Sites`=names(rate.x), check.names=FALSE)
 suppressMessages({
  suppressWarnings({
   if (type == "scatter") {
    gg = ggplot(newdf, aes(y=rate.y, x=rate.x, text=`Cancer Sites`)) + geom_point() + 
          ggtitle(paste("CDC WONDER incidence (all body sites): ", paste(MSA1, MSA2, sep=", "), sep="")) + 
          geom_abline(slope=1, intercept=0)
    if (logscale) gg = gg + scale_y_log10() + scale_x_log10() + xlab(MSA1) + ylab(MSA2)
    }
   ggplotly(gg) 
  })
 })
}
```


## Histograms
 
Histograms help visualize variability in a quantity of interest.  The range of the quantity
of interest is "binned" -- chopped up into intervals of equal width.  Midpoints of
bins are plotted on the x axis, and counts of values in bins are plotted on the y axis.

We illustrate with the CDC WONDER data on Prostate cancer incidence.

```{r lkhist, echo=FALSE}
make_hist(site="Prostate", binwidth=5, rate_table=littab)
```

We can change the character of the histogram display by reducing the bin width.


```{r lkhist2, echo=FALSE}
make_hist(site="Prostate", binwidth=2, rate_table=littab)
```

### Exercises

A.5.1 Based on the first histogram shown above, what is the most commonly
observed value for prostate cancer incidence (per 100,000 men) in metropolitan
statistical areas (MSAs) of the United States?  You can scroll over the display
to find values for particular MSAs.  Your answer can be a range of numbers.

A.5.2 Use the first histogram to report on the number of MSAs that report
prostate cancer incidence between 142 and 147 per 100,000 men.

A.5.3 The second histogram is produced from the same set of statistics as the
first, but uses a smaller "binwidth".  Comment on some differences between
the two displays.

A.5.4 Add a cell to your notebook using the "+" button, enter the command
`make_hist(site="Female Breast")` and press the "play" button.  What
is the most commonly reported rate of female breast cancer incidence in
MSAs in the US?

A.5.5 Hover over the leftmost block in the display.  What is the MSA with
lowest value of Female Breast cancer incidence, and what is the reported rate?

## Boxplots for comparisons

We can compare the variations in all cancer rates between MSAs in
different ways.  A famous approach is called the boxplot.

```{r lk2, echo=FALSE}
make_pair(rate_table=littab)
```

More detail can be obtained with an approach called "beeswarm" plotting.

```{r lk3, echo=FALSE}
ggplotly(make_pair(type="beeswarm", rate_table=littab ))
```
